{"version":3,"file":"spyfu-vue-factory.js","sources":["../lib/index.js"],"sourcesContent":["import merge from 'deepmerge';\r\nimport Vue from 'vue/dist/vue.common.js';\r\n\r\nlet vuexIsInstalled = false;\r\n\r\nlet routerIsInstalled = false;\r\n\r\n/**\r\n * Make a function that returns a component factory.\r\n *\r\n * @param  {Object}     factoryOpts\r\n * @return {Function}\r\n */\r\nexport default function (factoryOpts = {}) {\r\n    factoryOpts.components = factoryOpts.components || {};\r\n    // factoryOpts.modules = factoryOpts.modules || {};\r\n    factoryOpts.routes = factoryOpts.routes || [];\r\n\r\n    //\r\n    // component factory\r\n    //\r\n    return function (options, state) {\r\n        const baseOptions = {\r\n            components: factoryOpts.components,\r\n            el: document.createElement('div'),\r\n            template: '<div>no template</div>',\r\n        };\r\n\r\n        // create a vuex store\r\n        let store = undefined;\r\n\r\n        try  {\r\n            const Vuex = require('vuex');\r\n\r\n            if ((factoryOpts.modules || state) && !Vuex.version) {\r\n                throw new Error;\r\n            } else {\r\n                store = createStore(factoryOpts.modules || {}, state || {});\r\n    \r\n                baseOptions.store = store;\r\n            }\r\n        } catch (e) {\r\n            console.warn ('Missing \"vuex\" dependency, no state will be injected.');\r\n        }\r\n\r\n        // create a vue router\r\n        let router = undefined;\r\n\r\n        try {\r\n            const VueRouter = require('vue-router');\r\n\r\n            if (factoryOpts.routes && !VueRouter.version) {\r\n                throw new Error;\r\n            } else {\r\n                router = createRouter(factoryOpts.routes);\r\n            \r\n                baseOptions.router = router;\r\n            }\r\n        } catch (e) {\r\n            console.warn ('Missing \"vue-router\" dependency, no router will be injected.');\r\n        }\r\n\r\n        // sync the store with the router\r\n        if (store && router) {\r\n            try {\r\n                const { sync } = require('vuex-router-sync');\r\n    \r\n                if (sync) {\r\n                    sync(store, router);\r\n                }\r\n            } catch (e) {\r\n                // continue, regardless of error\r\n            }\r\n        }\r\n\r\n        // finally, return the instantiated vue component\r\n        return new Vue(Object.assign(baseOptions, options));\r\n    };\r\n}\r\n\r\n// helper function to create a router instance\r\nfunction createRouter(routes = []) {\r\n    const VueRouter = require('vue-router');\r\n    \r\n    if (!routerIsInstalled) {\r\n        Vue.use (VueRouter);\r\n        routerIsInstalled = true;\r\n    }\r\n\r\n    return new VueRouter({ abstract: true, routes });\r\n}\r\n\r\n// helper function to create a vuex store instance\r\nfunction createStore(rawModules, state) {\r\n    const Vuex = require('vuex');\r\n\r\n    if (!vuexIsInstalled) {\r\n        Vue.use(Vuex);\r\n        vuexIsInstalled = true;\r\n    }\r\n\r\n    // create a normalized copy of our vuex modules\r\n    const normalizedModules = normalizeModules(rawModules);\r\n\r\n    // merge in any test specific state\r\n    const modules = mergeTestState(normalizedModules, state);\r\n\r\n    // return the instantiated vuex store\r\n    return new Vuex.Store({ state, modules, strict: true });\r\n}\r\n\r\n// helper function to evaluate the state functions of vuex modules\r\nfunction normalizeModules(modules) {\r\n    const normalized = {};\r\n\r\n    Object.keys(modules).forEach((key) => {\r\n        const module = modules[key];\r\n\r\n        // make sure each vuex module has all keys defined\r\n        normalized[key] = {\r\n            actions: module.actions || {},\r\n            getters: module.getters || {},\r\n            modules: module.modules ? normalizeModules(module.modules) : {},\r\n            mutations: module.mutations || {},\r\n            namespaced: module.namespaced || false,\r\n            state: {},\r\n        };\r\n\r\n        // make sure our state is a fresh object\r\n        if (typeof module.state === 'function') {\r\n            normalized[key].state = module.state();\r\n        } else if (typeof module.state === 'object') {\r\n            normalized[key].state = JSON.parse(JSON.stringify(module.state));\r\n        }\r\n    });\r\n\r\n    return normalized;\r\n}\r\n\r\n// helper to find vuex modules via their namespace\r\nfunction findModule(store, namespace) {\r\n    return namespace.split('/').reduce((obj, key) => {\r\n        // root modules will exist directly on the store\r\n        if (obj && obj[key]) {\r\n            return obj[key];\r\n        }\r\n\r\n        // child stores will exist in a modules object\r\n        if (obj && obj.modules && obj.modules[key]) {\r\n            return obj.modules[key];\r\n        }\r\n\r\n        // if we couldn't find the module, throw an error\r\n        // istanbul ignore next\r\n        throw new Error(`Could not find module \"${namespace}\" in store.`);\r\n    }, store);\r\n}\r\n\r\n// helper function to merge state with vuex modules\r\nfunction mergeTestState(modules, state) {\r\n    Object.keys(state).forEach((key) => {\r\n        const module = findModule(modules, key);\r\n\r\n        if (module) {\r\n            module.state = merge(module.state, state[key]);\r\n        }\r\n    });\r\n\r\n    return modules;\r\n}\r\n"],"names":["vuexIsInstalled","routerIsInstalled","factoryOpts","components","routes","options","state","baseOptions","document","createElement","store","undefined","Vuex","require","modules","version","Error","createStore","e","warn","router","VueRouter","createRouter","sync","Vue","Object","assign","use","abstract","rawModules","normalizedModules","normalizeModules","mergeTestState","Store","strict","normalized","keys","forEach","key","module","actions","getters","mutations","namespaced","babelHelpers.typeof","JSON","parse","stringify","findModule","namespace","split","reduce","obj","merge"],"mappings":"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"}